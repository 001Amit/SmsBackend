<%- include('partials/header') %>



<div class="dashboard-container">

  <!-- Sidebar: Active Numbers -->
  <div class="sidebar">
    <h5 class="mt-2">Active Numbers</h5>
    <div class="forwarder-list">
      <% if (activeNumbers && activeNumbers.length > 0) { %>
        <% activeNumbers.forEach(number => { %>
          <a href="/admin/activeNumbers/<%= number %>" 
             class="forwarder-item <%= selectedNumber === number ? 'active' : '' %>">
            <%= number %>
          </a>
        <% }) %>
      <% } else { %>
        <p class="text-muted ms-2">No active numbers</p>
      <% } %>
    </div>
  </div>

  <!-- Messages Section -->
  <div class="messages-section">
    <h3>Messages <%= selectedNumber ? `(Filtered: ${selectedNumber})` : '' %></h3>

    <!-- Back button to remove filter -->
    <% if (selectedNumber) { %>
      <a href="/admin/dashboard" class="btn btn-secondary mb-2">‚Üê Show All Messages</a>
    <% } %>

    <table class="messages-table">
      <thead>
        <tr>
          <th>Sender</th>
          <th>Message</th>
          <th>SIM1</th>
          <th>SIM2</th>
          <th>Time</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="messages-body">
        <% messages.forEach(msg => { %>
          <tr>
            <td><%= msg.sender %></td>
            <td><%= msg.message %></td>
            <td><%= msg.deviceSim1 || '-' %></td>
            <td><%= msg.deviceSim2 || '-' %></td>
            <td><%= new Date(msg.createdAt).toLocaleString() %></td>
            <td>
              <form action="/admin/messages/<%= msg._id %>/delete" method="POST">
                <button type="submit">Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  // Live updates
  socket.on('newMessage', msg => {
    const selected = "<%= selectedNumber %>";
    if (!selected || msg.deviceSim1 === selected || msg.deviceSim2 === selected) {
      const tbody = document.getElementById('messages-body');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${msg.sender}</td>
        <td>${msg.message}</td>
        <td>${msg.deviceSim1 || '-'}</td>
        <td>${msg.deviceSim2 || '-'}</td>
        <td>${new Date(msg.createdAt).toLocaleString()}</td>
        <td>
          <form action="/admin/messages/${msg._id}/delete" method="POST">
            <button type="submit">Delete</button>
          </form>
        </td>
      `;
      tbody.prepend(row);
    }
  });
</script>

<%- include('partials/footer') %>
