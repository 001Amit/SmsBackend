<%- include('partials/header') %>

<h3>Messages (Total: <%= total %>)</h3>

<table class="table table-striped table-bordered" id="messagesTable">
  <thead>
    <tr>
      <th>Received At</th>
      <th>Sender</th>
      <th>Message</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <% messages.forEach(function(m) { %>
      <tr data-id="<%= m._id %>">
        <td><%= new Date(m.createdAt).toLocaleString() %></td>
        <td><%= m.sender %></td>
        <td><pre style="white-space:pre-wrap; margin:0;"><%= m.message %></pre></td>
        <td>
          <button class="btn btn-danger btn-sm delete-btn">Delete</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>

<nav>
  <ul class="pagination">
    <% for(let p=1; p<=pages; p++){ %>
      <li class="page-item <%= p===page ? 'active' : '' %>">
        <a class="page-link" href="/admin/dashboard?page=<%= p %>&limit=50"><%= p %></a>
      </li>
    <% } %>
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.delete-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      if (!confirm('Are you sure you want to delete this message?')) return;

      const row = btn.closest('tr');
      const id = row.getAttribute('data-id');

      fetch(`/admin/messages/${id}`, {
        method: 'DELETE',
        credentials: 'same-origin' // âœ… send session cookie
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          row.remove();
        } else {
          alert('Failed to delete message.');
        }
      })
      .catch(() => alert('Server error while deleting.'));
    });
  });
});
</script>

<%- include('partials/footer') %>
